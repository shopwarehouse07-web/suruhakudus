<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suruh Akudus - Lokasi Akurat üõµ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #007bff; --success: #28a745; --body-bg: #f4f7f9; --card-bg: #ffffff; --text-color: #333; }
        .dark-theme { --card-bg: #1e2125; --text-color: #e9ecef; --body-bg: #121416; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--body-bg); color: var(--text-color); padding: 15px; margin: 0; }
        .card { max-width: 450px; margin: auto; background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; font-size: 13px; margin-bottom: 20px; opacity: 0.8; }
        
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 13px; color: var(--primary); }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 10px; box-sizing: border-box; background: #fff; }
        
        #map { height: 300px; width: 100%; border-radius: 15px; margin-top: 15px; border: 2px solid var(--primary); }
        .instruksi-peta { font-size: 11px; color: #666; font-style: italic; margin-top: 5px; text-align: center; }

        .box-tarif { background: rgba(0, 123, 255, 0.1); padding: 15px; border-radius: 15px; margin-top: 20px; text-align: center; border: 1px solid var(--primary); }
        .total-harga { font-size: 30px; font-weight: 800; color: var(--primary); display: block; }
        
        #btn-pesan { width: 100%; padding: 15px; background: var(--success); color: white; border: none; border-radius: 12px; margin-top: 15px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .search-results { background: white; border: 1px solid #ccc; position: absolute; z-index: 1000; width: 100%; max-height: 150px; overflow-y: auto; display: none; border-radius: 8px; color: #333; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 12px; }
    </style>
</head>
<body>

<div class="card">
    <h2>SURUH AKUDUS üöÄ</h2>
    <p class="subtitle">Geser pin di peta untuk lokasi lebih akurat!</p>

    <label>Layanan</label>
    <select id="layanan" onchange="hitungTarif()">
        <option value="Ojek" data-harga="2500">Ojek Online (Rp2.500/km)</option>
        <option value="Kurir" data-harga="2000">Kurir Barang (Rp2.000/km)</option>
        <option value="Jastip" data-harga="2000">Jasa Titip Belanja (Rp2.000/km)</option>
    </select>

    <div style="position: relative;">
        <label>Titik Jemput üîµ</label>
        <input type="text" id="input-jemput" placeholder="Ketik atau geser pin biru..." oninput="cariAlamat('jemput')">
        <div id="res-jemput" class="search-results"></div>
    </div>

    <div style="position: relative;">
        <label>Titik Tujuan üî¥</label>
        <input type="text" id="input-tujuan" placeholder="Ketik atau geser pin merah..." oninput="cariAlamat('tujuan')">
        <div id="res-tujuan" class="search-results"></div>
    </div>

    <div id="map"></div>
    <p class="instruksi-peta">üí° Klik pada peta untuk pindahkan tujuan, atau geser pinnya.</p>

    <div class="box-tarif">
        <span id="tampilan-waktu" style="font-size: 12px; font-weight: bold;">Waktu Perjalanan: -</span>
        <span style="display: block; font-size: 12px; margin-top: 5px;">Total Estimasi Tarif:</span>
        <span class="total-harga" id="tampilan-tarif">Rp9.000</span>
        <small>Tarif minimal Rp9.000 (0-2 km)</small>
    </div>

    <button id="btn-pesan" onclick="prosesPesan()">PESAN SEKARANG ‚úÖ</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Inisialisasi Peta
    let map = L.map('map').setView([-6.8048, 110.8405], 13); // Fokus Kudus
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Marker Draggable (Bisa Digeser)
    let markerJemput = L.marker([-6.8000, 110.8400], {draggable: true}).addTo(map).bindPopup("Titik Jemput (Geser Saya)");
    let markerTujuan = L.marker([-6.8100, 110.8500], {draggable: true, icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        iconSize: [25, 41], iconAnchor: [12, 41]
    })}).addTo(map).bindPopup("Titik Tujuan (Geser Saya)");

    let lineRute = L.polyline([], {color: 'blue'}).addTo(map);
    let jarakFinal = 0;

    // Fungsi Ambil Alamat dari Koordinat (Reverse Geocode)
    async function getAlamat(lat, lon, targetId) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await res.json();
            document.getElementById(targetId).value = data.display_name.split(',').slice(0, 3).join(',');
            updateRute();
        } catch (e) {}
    }

    // Event saat Pin Digeser
    markerJemput.on('dragend', function(e) {
        let pos = markerJemput.getLatLng();
        getAlamat(pos.lat, pos.lng, 'input-jemput');
    });

    markerTujuan.on('dragend', function(e) {
        let pos = markerTujuan.getLatLng();
        getAlamat(pos.lat, pos.lng, 'input-tujuan');
    });

    // Event saat Peta Diklik (Pindahkan Tujuan)
    map.on('click', function(e) {
        markerTujuan.setLatLng(e.latlng);
        getAlamat(e.latlng.lat, e.latlng.lng, 'input-tujuan');
    });

    async function updateRute() {
        let p1 = markerJemput.getLatLng();
        let p2 = markerTujuan.getLatLng();
        
        lineRute.setLatLngs([p1, p2]);
        map.fitBounds(lineRute.getBounds(), {padding: [50, 50]});

        // Hitung Jarak via OSRM
        const url = `https://router.project-osrm.org/route/v1/driving/${p1.lng},${p1.lat};${p2.lng},${p2.lat}?overview=false`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.routes && data.routes[0]) {
            jarakFinal = (data.routes[0].distance / 1000).toFixed(1);
            hitungTarif();
        }
    }

    function hitungTarif() {
        const hKm = parseFloat(document.getElementById('layanan').selectedOptions[0].getAttribute('data-harga'));
        let total = (jarakFinal <= 2) ? 9000 : (jarakFinal * hKm);
        if (total < 9000) total = 9000;

        document.getElementById('tampilan-tarif').innerText = "Rp" + Math.round(total).toLocaleString('id-ID');
        document.getElementById('tampilan-waktu').innerText = `üïí Estimasi Perjalanan: ¬±${Math.ceil(jarakFinal * 2)} Menit`;
    }

    // Fungsi Cari Alamat (Ketik)
    async function cariAlamat(type) {
        const query = document.getElementById('input-' + type).value;
        const resDiv = document.getElementById('res-' + type);
        if (query.length < 3) return;

        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=3`);
        const data = await res.json();
        resDiv.innerHTML = '';
        resDiv.style.display = 'block';
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'search-item';
            div.innerText = item.display_name.split(',').slice(0, 3).join(',');
            div.onclick = () => {
                const pos = {lat: item.lat, lng: item.lon};
                if (type === 'jemput') markerJemput.setLatLng(pos);
                else markerTujuan.setLatLng(pos);
                document.getElementById('input-' + type).value = div.innerText;
                resDiv.style.display = 'none';
                updateRute();
            };
            resDiv.appendChild(div);
        });
    }

    function prosesPesan() {
        const teks = encodeURIComponent(`*PESANAN SURUH AKUDUS*\n\n` +
            `üìç Jemput: ${document.getElementById('input-jemput').value}\n` +
            `üèÅ Tujuan: ${document.getElementById('input-tujuan').value}\n` +
            `üõ£Ô∏è Jarak: ${jarakFinal} KM\n` +
            `üí∞ Tarif: ${document.getElementById('tampilan-tarif').innerText}\n` +
            `üìç Link Maps Tujuan: https://www.google.com/maps?q=${markerTujuan.getLatLng().lat},${markerTujuan.getLatLng().lng}`);
        window.open(`https://wa.me/6285124569347?text=${teks}`);
    }

    // Set alamat awal
    getAlamat(-6.8000, 110.8400, 'input-jemput');
    getAlamat(-6.8100, 110.8500, 'input-tujuan');
</script>
</body>
</html>

